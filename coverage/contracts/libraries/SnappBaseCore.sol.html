<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/libraries/SnappBaseCore.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libraries/</a> SnappBaseCore.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>54/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>54/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>13/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>63/63</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">152×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">439×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">357×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-yes">105×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">183×</span>
<span class="cline-any cline-yes">181×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">179×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">140×</span>
<span class="cline-any cline-yes">138×</span>
<span class="cline-any cline-yes">136×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">221×</span>
<span class="cline-any cline-yes">219×</span>
<span class="cline-any cline-yes">217×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">215×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">215×</span>
<span class="cline-any cline-yes">215×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">215×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">215×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">215×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">353×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.5.0;
&nbsp;
import "openzeppelin-solidity/contracts/token/ERC20/ERC20.sol";
import "@gnosis.pm/solidity-data-structures/contracts/libraries/IdToAddressBiMap.sol";
import "@gnosis.pm/solidity-data-structures/contracts/libraries/Merkle.sol";
import "../SnappBase.sol";
&nbsp;
&nbsp;
library SnappBaseCore {
    using Merkle for bytes32;
&nbsp;
    uint public constant MAX_UINT = 2**256 - 1;
    uint8 public constant MAX_ACCOUNT_ID = 100;
    uint8 public constant MAX_TOKENS = 30;
    uint8 public constant DEPOSIT_BATCH_SIZE = 100;
    uint8 public constant WITHDRAW_BATCH_SIZE = 100;
&nbsp;
    event WithdrawRequest(uint16 accountId, uint8 tokenId, uint128 amount, uint slot, uint16 slotIndex);
    event Deposit(uint16 accountId, uint8 tokenId, uint128 amount, uint slot, uint16 slotIndex);
    event StateTransition(uint8 transitionType, uint stateIndex, bytes32 stateHash, uint slot);
    event SnappInitialization(bytes32 stateHash, uint8 maxTokens, uint16 maxAccounts);
&nbsp;
    enum TransitionType {
        Deposit,
        Withdraw
    }
&nbsp;
    struct PendingBatch {
        uint16 size;                   // Number of elements in this batch
        bytes32 shaHash;               // Rolling shaHash of all batch content
        uint creationTimestamp;        // Timestamp of batch creation
        uint appliedAccountStateIndex; // accountState index when batch applied (for rollback), 0 implies not applied.
    }
&nbsp;
    struct ClaimableWithdrawState {
        bytes32 merkleRoot;                      // Merkle root of claimable withdraws in this block
        bool[WITHDRAW_BATCH_SIZE] claimedBitmap; // Bitmap signalling which withdraws have been claimed
        uint appliedAccountStateIndex;           // AccountState when this state was created (for rollback)
    }
&nbsp;
    struct Data {
        bytes32[] stateRoots;
        IdToAddressBiMap.Data registeredAccounts;
        IdToAddressBiMap.Data registeredTokens;
        uint8 numTokens;
        uint depositIndex;
        mapping (uint =&gt; PendingBatch) deposits;
        uint withdrawIndex;
        mapping (uint =&gt; PendingBatch) pendingWithdraws;
        mapping (uint =&gt; ClaimableWithdrawState) claimableWithdraws;
    }
&nbsp;
    function init(Data storage data) public {
        // The initial state should be Pederson hash of an empty balance tree
        bytes32 stateInit = bytes32(0);
        data.stateRoots.push(stateInit);
        data.depositIndex = MAX_UINT;
        data.withdrawIndex = MAX_UINT;
&nbsp;
        emit SnappInitialization(stateInit, MAX_TOKENS, MAX_ACCOUNT_ID);
    }
&nbsp;
    /**
     * Public View Methods
     */
    function stateIndex(Data storage data) public view returns (uint) {
        return data.stateRoots.length - 1;
    }
&nbsp;
    function publicKeyToAccountMap(Data storage data, address addr) public view returns (uint16) {
        return IdToAddressBiMap.getId(data.registeredAccounts, addr);
    }
&nbsp;
    function accountToPublicKeyMap(Data storage data, uint16 id) public view returns (address) {
        return IdToAddressBiMap.getAddressAt(data.registeredAccounts, id);
    }
&nbsp;
    function tokenIdToAddressMap(Data storage data, uint16 id) public view returns (address) {
        return IdToAddressBiMap.getAddressAt(data.registeredTokens, id);
    }
&nbsp;
    /**
     * General Snapp Functionality
     */
    function openAccount(Data storage data, uint16 accountId) public {
        require(accountId &lt; MAX_ACCOUNT_ID, "Account index exceeds max");
        require(
            IdToAddressBiMap.insert(data.registeredAccounts, accountId, msg.sender),
            "Address occupies slot or requested slot already taken"
        );
    }
&nbsp;
    function addToken(Data storage data, address _tokenAddress) public {
        require(data.numTokens + 1 &lt;= MAX_TOKENS, "Max tokens reached");
        require(
            IdToAddressBiMap.insert(data.registeredTokens, data.numTokens, _tokenAddress),
            "Token already registered"
        );
        data.numTokens++;
    }
&nbsp;
    /**
     * Deposits
     */
    function deposit(Data storage data, uint8 tokenId, uint128 amount) public {
        require(amount != 0, "Must deposit positive amount");
        require(IdToAddressBiMap.hasId(data.registeredTokens, tokenId), "Requested token is not registered");
        require(
            ERC20(tokenIdToAddressMap(data, tokenId)).transferFrom(msg.sender, address(this), amount),
            "Unsuccessful transfer"
        );
&nbsp;
        if (data.depositIndex == MAX_UINT ||
            data.deposits[data.depositIndex].size == DEPOSIT_BATCH_SIZE ||
            block.timestamp &gt; data.deposits[data.depositIndex].creationTimestamp + 3 minutes
        ) {
            data.depositIndex++;
            data.deposits[data.depositIndex] = PendingBatch({
                size: 0,
                shaHash: bytes32(0),
                creationTimestamp: block.timestamp,
                appliedAccountStateIndex: 0
            });
        }
&nbsp;
        // Update Deposit Hash based on request
        uint16 accountId = publicKeyToAccountMap(data, msg.sender);
        bytes32 nextDepositHash = sha256(
            abi.encodePacked(data.deposits[data.depositIndex].shaHash, encodeFlux(accountId, tokenId, amount))
        );
        data.deposits[data.depositIndex].shaHash = nextDepositHash;
&nbsp;
        emit Deposit(accountId, tokenId, amount, data.depositIndex, data.deposits[data.depositIndex].size);
        // Only increment size after event (so it is emitted as an index)
        data.deposits[data.depositIndex].size++;
    }
&nbsp;
    function applyDeposits(
        Data storage data,
        uint slot,
        bytes32 _currStateRoot,
        bytes32 _newStateRoot,
        bytes32 _depositHash
    ) public {
        require(slot != MAX_UINT &amp;&amp; slot &lt;= data.depositIndex, "Requested deposit slot does not exist");
        require(slot == 0 || data.deposits[slot-1].appliedAccountStateIndex != 0, "Must apply deposit slots in order!");
        require(data.deposits[slot].shaHash == _depositHash, "Deposits have been reorged");
        require(data.deposits[slot].appliedAccountStateIndex == 0, "Deposits already processed");
        require(
            block.timestamp &gt; data.deposits[slot].creationTimestamp + 3 minutes,
            "Requested deposit slot is still active"
        );
        require(data.stateRoots[stateIndex(data)] == _currStateRoot, "Incorrect State Root");
&nbsp;
        // Note that the only slot that can ever be empty is the first (at index zero)
        // This occurs when no deposits are made within the first 20 blocks of the contract's deployment
        // This code allows for the processing of the empty block and since it will only happen once
        // No, additional verification is necessary.
&nbsp;
        data.stateRoots.push(_newStateRoot);
        data.deposits[slot].appliedAccountStateIndex = stateIndex(data);
&nbsp;
        emit StateTransition(uint8(TransitionType.Deposit), stateIndex(data), _newStateRoot, slot);
    }
&nbsp;
    /**
     * Withdraws
     */
    function requestWithdrawal(Data storage data, uint8 tokenId, uint128 amount) public {
        require(amount != 0, "Must request positive amount");
        require(IdToAddressBiMap.hasId(data.registeredTokens, tokenId), "Requested token is not registered");
        require(
            ERC20(tokenIdToAddressMap(data, tokenId)).balanceOf(address(this)) &gt;= amount,
            "Requested amount exceeds contract's balance"
        );
&nbsp;
        // Determine or construct correct current withdraw state.
        // This is governed by WITHDRAW_BATCH_SIZE and creationTimestamp
        if (
            data.withdrawIndex == MAX_UINT ||
            data.pendingWithdraws[data.withdrawIndex].size == WITHDRAW_BATCH_SIZE ||
            block.timestamp &gt; data.pendingWithdraws[data.withdrawIndex].creationTimestamp + 3 minutes
        ) {
            data.withdrawIndex++;
            data.pendingWithdraws[data.withdrawIndex] = PendingBatch({
                size: 0,
                shaHash: bytes32(0),
                creationTimestamp: block.timestamp,
                appliedAccountStateIndex: 0
            });
        }
&nbsp;
        // Update Withdraw Hash based on request
        uint16 accountId = publicKeyToAccountMap(data, msg.sender);
        bytes32 nextWithdrawHash = sha256(
            abi.encodePacked(data.pendingWithdraws[data.withdrawIndex].shaHash, encodeFlux(accountId, tokenId, amount))
        );
&nbsp;
        data.pendingWithdraws[data.withdrawIndex].shaHash = nextWithdrawHash;
&nbsp;
        emit WithdrawRequest(accountId, tokenId, amount, data.withdrawIndex, data.pendingWithdraws[data.withdrawIndex].size);
        // Only increment size after event (so it is emitted as an index)
        data.pendingWithdraws[data.withdrawIndex].size++;
    }
&nbsp;
    function applyWithdrawals(
        Data storage data,
        uint slot,
        bytes32 _merkleRoot,
        bytes32 _currStateRoot,
        bytes32 _newStateRoot,
        bytes32 _withdrawHash
    ) public {
        require(slot != MAX_UINT &amp;&amp; slot &lt;= data.withdrawIndex, "Requested withdrawal slot does not exist");
        require(
            slot == 0 || data.pendingWithdraws[slot-1].appliedAccountStateIndex != 0,
            "Previous withdraw slot not processed!"
        );
        require(data.pendingWithdraws[slot].shaHash == _withdrawHash, "Withdraws have been reorged");
        require(data.pendingWithdraws[slot].appliedAccountStateIndex == 0, "Withdraws already processed");
        require(
            block.timestamp &gt; data.pendingWithdraws[slot].creationTimestamp + 3 minutes,
            "Requested withdraw slot is still active");
        require(data.stateRoots[stateIndex(data)] == _currStateRoot, "Incorrect State Root");
&nbsp;
        // Update account states
        data.stateRoots.push(_newStateRoot);
        data.pendingWithdraws[slot].appliedAccountStateIndex = stateIndex(data);
&nbsp;
        bool[WITHDRAW_BATCH_SIZE] memory nullArray;
        data.claimableWithdraws[slot] = ClaimableWithdrawState({
            merkleRoot: _merkleRoot,
            claimedBitmap: nullArray,
            appliedAccountStateIndex: stateIndex(data)
        });
&nbsp;
        emit StateTransition(uint8(TransitionType.Withdraw), stateIndex(data), _newStateRoot, slot);
    }
&nbsp;
    function claimWithdrawal(
        Data storage data,
        uint slot,
        uint16 inclusionIndex,
        uint16 accountId,
        uint8 tokenId,
        uint128 amount,
        bytes memory proof
    ) public {
        // No need to check tokenId or accountId (wouldn't pass merkle proof if unregistered).
        require(data.pendingWithdraws[slot].appliedAccountStateIndex &gt; 0, "Requested slot has not been processed");
        require(data.claimableWithdraws[slot].claimedBitmap[inclusionIndex] == false, "Already claimed");
&nbsp;
        bytes32 leaf = encodeFlux(accountId, tokenId, amount);
        require(
            leaf.checkMembership(inclusionIndex, data.claimableWithdraws[slot].merkleRoot, proof, 7),
            "Failed Merkle membership check."
        );
&nbsp;
        // Set claim bitmap to true (indicating that funds have been claimed).
        data.claimableWithdraws[slot].claimedBitmap[inclusionIndex] = true;
&nbsp;
        // There is no situation where contract balance can't afford the upcoming transfer.
        ERC20(tokenIdToAddressMap(data, tokenId)).transfer(accountToPublicKeyMap(data, accountId), amount);
    }
&nbsp;
    function encodeFlux(uint16 accountId, uint8 tokenId, uint128 amount) internal pure returns (bytes32) {
        return bytes32(uint(amount) + (uint(tokenId) &lt;&lt; 128) + (uint(accountId) &lt;&lt; 136));
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Oct 23 2019 17:06:18 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
